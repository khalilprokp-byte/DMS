<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Management System - v4.0 (Updated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { 
            font-family: 'Inter', sans-serif; 
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-size: 14px;
        }
        
        /* Mobile-optimized font sizes */
        @media (max-width: 768px) {
            body { font-size: 15px; }
            h1 { font-size: 1.5rem !important; }
            h2 { font-size: 1.25rem !important; }
            h3 { font-size: 1.1rem !important; }
            .stat-value { font-size: 1.5rem !important; }
            .btn { padding: 0.6rem 1rem !important; font-size: 0.9rem !important; }
        }
        
        .sidebar { 
            width: 260px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            box-shadow: 4px 0 12px rgba(0,0,0,0.1);
        }
        
        .main-content { 
            margin-left: 260px; 
            transition: all 0.3s;
        }
        
        @media (max-width: 768px) {
            .sidebar { 
                transform: translateX(-100%); 
                position: fixed; 
                left: 0; 
                z-index: 50; 
                height: 100vh; 
            }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
        
        /* Smaller, more compact cards */
        .card { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.06); 
            padding: 1rem; 
            transition: all 0.3s;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .card:hover {
            box-shadow: 0 4px 18px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.9rem;
        }
        
        .stat-card-green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card-blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-card-orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .btn { 
            padding: 0.6rem 1.1rem; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            font-size: 0.875rem;
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .btn-secondary { background: #e2e8f0; color: #334155; }
        
        .input { 
            width: 100%; 
            padding: 0.6rem; 
            border: 2px solid #e2e8f0; 
            border-radius: 6px; 
            transition: all 0.3s;
            font-size: 0.875rem;
        }
        
        .input:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .nav-item { 
            cursor: pointer; 
            padding: 0.8rem 1.2rem; 
            transition: all 0.3s;
            border-radius: 8px;
            margin: 0.3rem;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-weight: 500;
        }
        
        .nav-item:hover { background: rgba(255,255,255,0.15); }
        .nav-item.active { background: rgba(255,255,255,0.25); font-weight: 700; }
        
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.4s; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Image upload preview */
        .image-preview {
            display: inline-block;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            margin: 0.5rem;
            position: relative;
            border: 2px solid #e2e8f0;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.3s;
        }
        
        .notification-item:hover {
            background: #f8fafc;
        }
        
        .notification-unread {
            background: #eff6ff;
        }
        
        /* Table styles */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 700; color: #334155; }
        tr:hover { background: #f8fafc; }
        
        @media (max-width: 768px) {
            table { font-size: 0.8rem; }
            th, td { padding: 0.5rem 0.3rem; }
        }
        
        /* Status badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-training { background: #fef3c7; color: #92400e; }
        .badge-active { background: #d1fae5; color: #065f46; }
        .badge-inactive { background: #fee2e2; color: #991b1b; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-completed { background: #d1fae5; color: #065f46; }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button id="mobile-menu-toggle" class="fixed top-4 left-4 z-50 md:hidden bg-white p-3 rounded-lg shadow-lg" onclick="toggleSidebar()">
        ‚ò∞
    </button>

    <!-- Sidebar Navigation -->
    <div class="sidebar fixed h-full overflow-y-auto" id="sidebar">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-white mb-2">üöó DMS Pro</h1>
            <p class="text-white/70 text-sm">Driver Management System</p>
            <p class="text-white/50 text-xs mt-1">v4.0 - Updated</p>
        </div>
        
        <nav class="px-3 pb-6">
            <div class="nav-item text-white active" onclick="showPage('dashboard')">
                üìä Dashboard
            </div>
            <div class="nav-item text-white" onclick="showPage('drivers')">
                üë®‚Äç‚úàÔ∏è Drivers
            </div>
            <div class="nav-item text-white" onclick="showPage('companies')">
                üè¢ Companies
            </div>
            <div class="nav-item text-white" onclick="showPage('orders')">
                üì¶ Orders
            </div>
            <div class="nav-item text-white" onclick="showPage('salaries')">
                üí∞ Salaries
            </div>
            <div class="nav-item text-white" onclick="showPage('advances')">
                üí∏ Advances
            </div>
            <div class="nav-item text-white" onclick="showPage('reports')">
                üìà Reports
            </div>
            <div class="nav-item text-white" onclick="showPage('notifications')" style="position: relative;">
                üîî Notifications
                <span id="notification-count" class="notification-badge" style="display: none;">0</span>
            </div>
            <div class="nav-item text-white" onclick="showPage('settings')">
                ‚öôÔ∏è Settings
            </div>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content p-4 md:p-8">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page-section active">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üìä Dashboard</h1>
                    <p class="text-gray-600 mt-1">System Overview & Statistics</p>
                </div>
                <button class="btn btn-primary" onclick="openRequestModal()">
                    ‚ûï Add Request
                </button>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="card stat-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-white/80 text-sm font-medium">Total Drivers</p>
                            <p class="text-3xl font-bold mt-2 stat-value" id="stat-drivers">0</p>
                        </div>
                        <div class="text-4xl">üë®‚Äç‚úàÔ∏è</div>
                    </div>
                </div>
                <div class="card stat-card stat-card-green">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-white/80 text-sm font-medium">Active Companies</p>
                            <p class="text-3xl font-bold mt-2 stat-value" id="stat-companies">0</p>
                        </div>
                        <div class="text-4xl">üè¢</div>
                    </div>
                </div>
                <div class="card stat-card stat-card-blue">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-white/80 text-sm font-medium">Total Orders</p>
                            <p class="text-3xl font-bold mt-2 stat-value" id="stat-orders">0</p>
                        </div>
                        <div class="text-4xl">üì¶</div>
                    </div>
                </div>
                <div class="card stat-card stat-card-orange">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-white/80 text-sm font-medium">Total Revenue</p>
                            <p class="text-3xl font-bold mt-2 stat-value" id="stat-revenue">¬£0</p>
                        </div>
                        <div class="text-4xl">üí∑</div>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">üìå Recent Orders</h3>
                    <div id="recent-orders">
                        <p class="text-gray-500 text-sm">No recent orders</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">üë• Active Drivers</h3>
                    <div id="active-drivers">
                        <p class="text-gray-500 text-sm">No active drivers</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drivers Page -->
        <div id="drivers" class="page-section">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üë®‚Äç‚úàÔ∏è Drivers</h1>
                    <p class="text-gray-600 mt-1">Manage Driver Information</p>
                </div>
                <button class="btn btn-primary" onclick="openDriverModal()">
                    ‚ûï Add Driver
                </button>
            </div>

            <div class="card">
                <div class="mb-4">
                    <input type="text" id="driver-search" class="input" placeholder="üîç Search drivers by name, phone, or email..." onkeyup="searchDrivers()">
                </div>
                <div class="overflow-x-auto">
                    <table id="drivers-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Join Date</th>
                                <th>Status</th>
                                <th>Advances</th>
                                <th>Stops Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="drivers-tbody">
                            <tr><td colspan="8" class="text-center text-gray-500">No drivers found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Companies Page -->
        <div id="companies" class="page-section">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üè¢ Companies</h1>
                    <p class="text-gray-600 mt-1">Manage Company Information</p>
                </div>
                <button class="btn btn-primary" onclick="openCompanyModal()">
                    ‚ûï Add Company
                </button>
            </div>

            <div class="card">
                <div class="mb-4">
                    <input type="text" id="company-search" class="input" placeholder="üîç Search companies..." onkeyup="searchCompanies()">
                </div>
                <div class="overflow-x-auto">
                    <table id="companies-table">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Contact Person</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="companies-tbody">
                            <tr><td colspan="6" class="text-center text-gray-500">No companies found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Page -->
        <div id="orders" class="page-section">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üì¶ Orders</h1>
                    <p class="text-gray-600 mt-1">Manage Orders & Deliveries</p>
                </div>
                <button class="btn btn-primary" onclick="openOrderModal()">
                    ‚ûï Add Order
                </button>
            </div>

            <div class="card">
                <div class="mb-4">
                    <input type="text" id="order-search" class="input" placeholder="üîç Search orders..." onkeyup="searchOrders()">
                </div>
                <div class="overflow-x-auto">
                    <table id="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Company</th>
                                <th>Driver</th>
                                <th>Revenue</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <tr><td colspan="7" class="text-center text-gray-500">No orders found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Salaries Page -->
        <div id="salaries" class="page-section">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üí∞ Salaries</h1>
                    <p class="text-gray-600 mt-1">Calculate & Manage Driver Salaries</p>
                </div>
                <button class="btn btn-success" onclick="calculateAllSalaries()">
                    üßÆ Calculate Salaries
                </button>
            </div>

            <div class="card mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Start Date</label>
                        <input type="date" id="salary-start-date" class="input">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">End Date</label>
                        <input type="date" id="salary-end-date" class="input">
                    </div>
                    <div class="flex items-end">
                        <button class="btn btn-primary w-full" onclick="filterSalaries()">
                            üîç Filter
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="overflow-x-auto">
                    <table id="salaries-table">
                        <thead>
                            <tr>
                                <th>Driver Name</th>
                                <th>Period</th>
                                <th>Orders</th>
                                <th>Base Salary</th>
                                <th>Bonus</th>
                                <th>Advances</th>
                                <th>Net Salary</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="salaries-tbody">
                            <tr><td colspan="8" class="text-center text-gray-500">No salary data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Advances Page -->
        <div id="advances" class="page-section">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üí∏ Advances</h1>
                    <p class="text-gray-600 mt-1">Manage Driver Advances & Loans</p>
                </div>
                <button class="btn btn-primary" onclick="openAdvanceModal()">
                    ‚ûï Add Advance
                </button>
            </div>

            <div class="card">
                <div class="overflow-x-auto">
                    <table id="advances-table">
                        <thead>
                            <tr>
                                <th>Driver Name</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Remaining</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="advances-tbody">
                            <tr><td colspan="6" class="text-center text-gray-500">No advances found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reports" class="page-section">
            <div class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800">üìà Reports</h1>
                <p class="text-gray-600 mt-1">Daily Profit & Performance Analytics</p>
            </div>

            <div class="card mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Report Type</label>
                        <select id="report-type" class="input">
                            <option value="daily">Daily Report</option>
                            <option value="weekly">Weekly Report</option>
                            <option value="monthly">Monthly Report</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Date</label>
                        <input type="date" id="report-date" class="input">
                    </div>
                    <div class="flex items-end gap-2">
                        <button class="btn btn-primary flex-1" onclick="generateReport()">
                            üìä Generate
                        </button>
                        <button class="btn btn-success flex-1" onclick="exportReport()">
                            üíæ Export
                        </button>
                    </div>
                </div>
            </div>

            <div id="report-content" class="card">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Daily Profit Report</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 font-medium">Completed Orders</p>
                        <p class="text-2xl font-bold text-blue-600" id="report-orders">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 font-medium">Total Revenue</p>
                        <p class="text-2xl font-bold text-green-600" id="report-revenue">¬£0.00</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 font-medium">Driver Costs</p>
                        <p class="text-2xl font-bold text-red-600" id="report-costs">¬£0.00</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 font-medium">Net Profit</p>
                        <p class="text-2xl font-bold text-purple-600" id="report-profit">¬£0.00</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="report-details-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Driver</th>
                                <th>Orders</th>
                                <th>Revenue</th>
                                <th>Cost</th>
                                <th>Profit</th>
                            </tr>
                        </thead>
                        <tbody id="report-tbody">
                            <tr><td colspan="6" class="text-center text-gray-500">Generate a report to see data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Notifications Page -->
        <div id="notifications" class="page-section">
            <div class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800">üîî Notifications</h1>
                <p class="text-gray-600 mt-1">Training Completion & System Alerts</p>
            </div>

            <div class="card">
                <div id="notifications-list">
                    <p class="text-gray-500 text-center py-8">No notifications</p>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page-section">
            <div class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800">‚öôÔ∏è Settings</h1>
                <p class="text-gray-600 mt-1">System Configuration & Data Management</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üíº Business Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Training Period (Days)</label>
                            <input type="number" id="setting-training-days" class="input" value="15" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Base Salary Target (Orders)</label>
                            <input type="number" id="setting-target-orders" class="input" value="100" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Base Salary Amount (¬£)</label>
                            <input type="number" id="setting-base-salary" class="input" value="120" min="0" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Bonus Per Extra Order (¬£)</label>
                            <input type="number" id="setting-bonus-per-order" class="input" value="1" min="0" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Driver Cost Per Order (¬£)</label>
                            <input type="number" id="setting-driver-cost" class="input" value="1.2" min="0" step="0.01">
                        </div>
                        <button class="btn btn-success w-full" onclick="saveSettings()">
                            üíæ Save Settings
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üíæ Data Management</h3>
                    <div class="space-y-3">
                        <button class="btn btn-primary w-full" onclick="exportAllData()">
                            üì§ Export All Data
                        </button>
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Import Backup</label>
                            <input type="file" id="import-file" class="input" accept=".json">
                            <button class="btn btn-warning w-full mt-2" onclick="importData()">
                                üì• Import Data
                            </button>
                        </div>
                        <hr class="my-4">
                        <button class="btn btn-danger w-full" onclick="clearAllData()">
                            üóëÔ∏è Clear All Data
                        </button>
                        <p class="text-xs text-gray-500 mt-2">‚ö†Ô∏è Warning: This will delete all data permanently!</p>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4">‚ÑπÔ∏è System Information</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-600">Version:</p>
                        <p class="font-bold">3.0 Professional</p>
                    </div>
                    <div>
                        <p class="text-gray-600">Last Backup:</p>
                        <p class="font-bold" id="last-backup">Never</p>
                    </div>
                    <div>
                        <p class="text-gray-600">Total Records:</p>
                        <p class="font-bold" id="total-records">0</p>
                    </div>
                    <div>
                        <p class="text-gray-600">Storage Used:</p>
                        <p class="font-bold" id="storage-used">0 KB</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Modal -->
    <div id="driver-modal" class="modal">
        <div class="modal-content w-full max-w-3xl p-6 md:p-8">
            <div class="flex justify-between items-center mb-6 pb-4 border-b-2">
                <h2 class="text-2xl font-bold text-gray-800">
                    <span id="driver-modal-title">üë®‚Äç‚úàÔ∏è Add New Driver</span>
                </h2>
                <button onclick="closeDriverModal()" class="text-3xl text-gray-500 hover:text-red-600 transition">√ó</button>
            </div>
            <form id="driver-form" onsubmit="saveDriver(event)">
                <input type="hidden" id="driver-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Full Name *</label>
                        <input type="text" id="driver-name" class="input" required placeholder="John Smith">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Phone Number *</label>
                        <input type="tel" id="driver-phone" class="input" required placeholder="+447700900000">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Email Address *</label>
                        <input type="email" id="driver-email" class="input" required placeholder="john.smith@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Join Date *</label>
                        <input type="date" id="driver-join-date" class="input" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2 text-gray-700">Upload Documents (ID, Passport, etc.)</label>
                        <input type="file" id="driver-documents" class="input" multiple accept="image/*" onchange="previewDocuments(event)">
                        <div id="document-previews" class="mt-3 flex flex-wrap gap-2"></div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold mb-2 text-gray-700">Notes</label>
                        <textarea id="driver-notes" class="input" rows="2" placeholder="Additional information..."></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="btn btn-success flex-1">üíæ Save Driver</button>
                    <button type="button" onclick="closeDriverModal()" class="btn btn-secondary flex-1">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Company Modal -->
    <div id="company-modal" class="modal">
        <div class="modal-content w-full max-w-2xl p-6 md:p-8">
            <div class="flex justify-between items-center mb-6 pb-4 border-b-2">
                <h2 class="text-2xl font-bold text-gray-800">
                    <span id="company-modal-title">üè¢ Add New Company</span>
                </h2>
                <button onclick="closeCompanyModal()" class="text-3xl text-gray-500 hover:text-red-600 transition">√ó</button>
            </div>
            <form id="company-form" onsubmit="saveCompany(event)">
                <input type="hidden" id="company-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Company Name *</label>
                        <input type="text" id="company-name" class="input" required placeholder="Company A Ltd">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Contact Person *</label>
                        <input type="text" id="company-contact" class="input" required placeholder="Jane Doe">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Phone Number *</label>
                        <input type="tel" id="company-phone" class="input" required placeholder="+447700900888">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Email *</label>
                        <input type="email" id="company-email" class="input" required placeholder="contact@company.com">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Status *</label>
                        <select id="company-status" class="input" required>
                            <option value="active">‚úÖ Active</option>
                            <option value="inactive">‚è∏Ô∏è Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-bold mb-2 text-gray-700">Notes</label>
                    <textarea id="company-notes" class="input" rows="2" placeholder="Special instructions..."></textarea>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="btn btn-success flex-1">üíæ Save Company</button>
                    <button type="button" onclick="closeCompanyModal()" class="btn btn-secondary flex-1">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content w-full max-w-2xl p-6 md:p-8">
            <div class="flex justify-between items-center mb-6 pb-4 border-b-2">
                <h2 class="text-2xl font-bold text-gray-800">
                    <span id="order-modal-title">üì¶ Add New Order</span>
                </h2>
                <button onclick="closeOrderModal()" class="text-3xl text-gray-500 hover:text-red-600 transition">√ó</button>
            </div>
            <form id="order-form" onsubmit="saveOrder(event)">
                <input type="hidden" id="order-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Company *</label>
                        <select id="order-company" class="input" required>
                            <option value="">-- Select Company --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Driver *</label>
                        <select id="order-driver" class="input" required>
                            <option value="">-- Select Driver --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Date *</label>
                        <input type="date" id="order-date" class="input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Postcode</label>
                        <input type="text" id="order-postcode" class="input" placeholder="SW1A 1AA">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Customer Name</label>
                        <input type="text" id="order-customer" class="input" placeholder="John Smith">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Customer Phone</label>
                        <input type="tel" id="order-customer-phone" class="input" placeholder="+447700900001">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Revenue (¬£) *</label>
                        <input type="number" id="order-revenue" class="input" required min="0" step="0.01" placeholder="15.00">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Status *</label>
                        <select id="order-status" class="input" required>
                            <option value="pending">‚è≥ Pending</option>
                            <option value="in_progress">üîÑ In Progress</option>
                            <option value="completed">‚úÖ Completed</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-bold mb-2 text-gray-700">Notes</label>
                    <textarea id="order-notes" class="input" rows="2" placeholder="Additional notes..."></textarea>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="btn btn-success flex-1">üíæ Save Order</button>
                    <button type="button" onclick="closeOrderModal()" class="btn btn-secondary flex-1">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Advance Modal -->
    <div id="advance-modal" class="modal">
        <div class="modal-content w-full max-w-xl p-6 md:p-8">
            <div class="flex justify-between items-center mb-6 pb-4 border-b-2">
                <h2 class="text-2xl font-bold text-gray-800">
                    <span id="advance-modal-title">üí∏ Add Advance</span>
                </h2>
                <button onclick="closeAdvanceModal()" class="text-3xl text-gray-500 hover:text-red-600 transition">√ó</button>
            </div>
            <form id="advance-form" onsubmit="saveAdvance(event)">
                <input type="hidden" id="advance-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Driver *</label>
                        <select id="advance-driver" class="input" required>
                            <option value="">-- Select Driver --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Date *</label>
                        <input type="date" id="advance-date" class="input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Amount (¬£) *</label>
                        <input type="number" id="advance-amount" class="input" required min="0" step="0.01" placeholder="50.00">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Deduction Type *</label>
                        <select id="advance-deduction-type" class="input" required>
                            <option value="full">Full Deduction</option>
                            <option value="partial">Partial Deduction</option>
                        </select>
                    </div>
                    <div id="partial-deduction-section" style="display: none;">
                        <label class="block text-sm font-bold mb-2 text-gray-700">Deduction Per Salary (¬£)</label>
                        <input type="number" id="advance-partial-amount" class="input" min="0" step="0.01" placeholder="25.00">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Notes</label>
                        <textarea id="advance-notes" class="input" rows="2" placeholder="Reason for advance..."></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="btn btn-success flex-1">üíæ Save Advance</button>
                    <button type="button" onclick="closeAdvanceModal()" class="btn btn-secondary flex-1">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Modal -->
    <div id="request-modal" class="modal">
        <div class="modal-content w-full max-w-xl p-6 md:p-8">
            <div class="flex justify-between items-center mb-6 pb-4 border-b-2">
                <h2 class="text-2xl font-bold text-gray-800">üìù Add Request</h2>
                <button onclick="closeRequestModal()" class="text-3xl text-gray-500 hover:text-red-600 transition">√ó</button>
            </div>
            <form onsubmit="saveRequest(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Request Type *</label>
                        <select id="request-type" class="input" required>
                            <option value="">-- Select Type --</option>
                            <option value="driver">Add Driver</option>
                            <option value="company">Add Company</option>
                            <option value="order">Add Order</option>
                            <option value="advance">Request Advance</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-700">Description *</label>
                        <textarea id="request-description" class="input" rows="4" required placeholder="Describe your request..."></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="btn btn-success flex-1">üì§ Submit Request</button>
                    <button type="button" onclick="closeRequestModal()" class="btn btn-secondary flex-1">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="training-notification-modal" class="modal">
        <div class="modal-content w-full max-w-lg p-6 md:p-8">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">üéì</div>
                <h2 class="text-2xl font-bold text-gray-800">Training Period Complete!</h2>
            </div>
            <div id="notification-content" class="text-center mb-6">
                <p class="text-gray-700 mb-4"></p>
            </div>
            <div class="flex gap-3">
                <button class="btn btn-success flex-1" onclick="confirmSalaryActivation()">
                    ‚úÖ Activate Salary
                </button>
                <button class="btn btn-secondary flex-1" onclick="closeTrainingNotificationModal()">
                    Later
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global State Management
        let drivers = JSON.parse(localStorage.getItem('drivers')) || [];
        let companies = JSON.parse(localStorage.getItem('companies')) || [];
        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        let advances = JSON.parse(localStorage.getItem('advances')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            trainingDays: 15,
            targetOrders: 100,
            baseSalary: 120,
            bonusPerOrder: 1,
            driverCostPerOrder: 1.2
        };

        let currentEditId = null;
        let currentNotificationDriverId = null;
        let uploadedDocuments = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('salary-start-date').value = today;
            document.getElementById('salary-end-date').value = today;
            document.getElementById('report-date').value = today;
            document.getElementById('driver-join-date').value = today;
            document.getElementById('order-date').value = today;
            document.getElementById('advance-date').value = today;
            
            // Load settings
            loadSettings();
            
            // Render initial data
            renderDashboard();
            renderDrivers();
            renderCompanies();
            renderOrders();
            renderAdvances();
            
            // Check for training period completions
            checkTrainingPeriods();
            
            // Update notification badge
            updateNotificationBadge();
            
            // Setup advance deduction type handler
            document.getElementById('advance-deduction-type').addEventListener('change', function() {
                const partialSection = document.getElementById('partial-deduction-section');
                partialSection.style.display = this.value === 'partial' ? 'block' : 'none';
            });
        }

        // Page Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Close mobile sidebar
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
            
            // Refresh page data
            if (pageId === 'dashboard') renderDashboard();
            else if (pageId === 'drivers') renderDrivers();
            else if (pageId === 'companies') renderCompanies();
            else if (pageId === 'orders') renderOrders();
            else if (pageId === 'salaries') renderSalaries();
            else if (pageId === 'advances') renderAdvances();
            else if (pageId === 'reports') generateReport();
            else if (pageId === 'notifications') renderNotifications();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Settings Management
        function loadSettings() {
            document.getElementById('setting-training-days').value = settings.trainingDays;
            document.getElementById('setting-target-orders').value = settings.targetOrders;
            document.getElementById('setting-base-salary').value = settings.baseSalary;
            document.getElementById('setting-bonus-per-order').value = settings.bonusPerOrder;
            document.getElementById('setting-driver-cost').value = settings.driverCostPerOrder;
            
            updateSystemInfo();
        }

        function saveSettings() {
            settings = {
                trainingDays: parseInt(document.getElementById('setting-training-days').value),
                targetOrders: parseInt(document.getElementById('setting-target-orders').value),
                baseSalary: parseFloat(document.getElementById('setting-base-salary').value),
                bonusPerOrder: parseFloat(document.getElementById('setting-bonus-per-order').value),
                driverCostPerOrder: parseFloat(document.getElementById('setting-driver-cost').value)
            };
            
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('‚úÖ Settings saved successfully!');
        }

        function updateSystemInfo() {
            const totalRecords = drivers.length + companies.length + orders.length + advances.length;
            document.getElementById('total-records').textContent = totalRecords;
            
            const storageSize = new Blob([JSON.stringify({drivers, companies, orders, advances})]).size;
            document.getElementById('storage-used').textContent = (storageSize / 1024).toFixed(2) + ' KB';
        }

        // Document Upload Management
        function previewDocuments(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('document-previews');
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'image-preview';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Document ${index + 1}">
                        <div class="image-preview-remove" onclick="removeDocument(${uploadedDocuments.length})">√ó</div>
                    `;
                    previewContainer.appendChild(preview);
                    
                    uploadedDocuments.push(e.target.result);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeDocument(index) {
            uploadedDocuments.splice(index, 1);
            const previewContainer = document.getElementById('document-previews');
            previewContainer.innerHTML = '';
            
            uploadedDocuments.forEach((doc, i) => {
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.innerHTML = `
                    <img src="${doc}" alt="Document ${i + 1}">
                    <div class="image-preview-remove" onclick="removeDocument(${i})">√ó</div>
                `;
                previewContainer.appendChild(preview);
            });
        }

        // Driver Management
        function openDriverModal(id = null) {
            const modal = document.getElementById('driver-modal');
            const title = document.getElementById('driver-modal-title');
            const form = document.getElementById('driver-form');
            
            form.reset();
            uploadedDocuments = [];
            document.getElementById('document-previews').innerHTML = '';
            
            if (id) {
                const driver = drivers.find(d => d.id === id);
                title.textContent = '‚úèÔ∏è Edit Driver';
                document.getElementById('driver-id').value = driver.id;
                document.getElementById('driver-name').value = driver.name;
                document.getElementById('driver-phone').value = driver.phone;
                document.getElementById('driver-email').value = driver.email;
                document.getElementById('driver-join-date').value = driver.joinDate;
                document.getElementById('driver-notes').value = driver.notes || '';
                
                if (driver.documents) {
                    uploadedDocuments = driver.documents;
                    const previewContainer = document.getElementById('document-previews');
                    driver.documents.forEach((doc, i) => {
                        const preview = document.createElement('div');
                        preview.className = 'image-preview';
                        preview.innerHTML = `
                            <img src="${doc}" alt="Document ${i + 1}">
                            <div class="image-preview-remove" onclick="removeDocument(${i})">√ó</div>
                        `;
                        previewContainer.appendChild(preview);
                    });
                }
            } else {
                title.textContent = 'üë®‚Äç‚úàÔ∏è Add New Driver';
                document.getElementById('driver-id').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeDriverModal() {
            document.getElementById('driver-modal').classList.remove('active');
            uploadedDocuments = [];
        }

        function saveDriver(event) {
            event.preventDefault();
            
            const id = document.getElementById('driver-id').value;
            const driver = {
                id: id || Date.now().toString(),
                name: document.getElementById('driver-name').value,
                phone: document.getElementById('driver-phone').value,
                email: document.getElementById('driver-email').value,
                joinDate: document.getElementById('driver-join-date').value,
                notes: document.getElementById('driver-notes').value,
                documents: uploadedDocuments,
                status: 'training', // Initial status
                salaryActivated: false,
                createdAt: id ? drivers.find(d => d.id === id).createdAt : new Date().toISOString()
            };
            
            if (id) {
                const index = drivers.findIndex(d => d.id === id);
                drivers[index] = { ...drivers[index], ...driver };
            } else {
                drivers.push(driver);
                
                // Create notification for training period
                const notification = {
                    id: Date.now().toString(),
                    driverId: driver.id,
                    driverName: driver.name,
                    type: 'training_complete',
                    message: `${driver.name} will complete training period on ${calculateTrainingEndDate(driver.joinDate)}`,
                    targetDate: calculateTrainingEndDate(driver.joinDate),
                    read: false,
                    createdAt: new Date().toISOString()
                };
                notifications.push(notification);
                localStorage.setItem('notifications', JSON.stringify(notifications));
            }
            
            localStorage.setItem('drivers', JSON.stringify(drivers));
            
            closeDriverModal();
            renderDrivers();
            renderDashboard();
            updateNotificationBadge();
            
            alert('‚úÖ Driver saved successfully!');
        }

        function deleteDriver(id) {
            if (!confirm('Are you sure you want to delete this driver?')) return;
            
            drivers = drivers.filter(d => d.id !== id);
            localStorage.setItem('drivers', JSON.stringify(drivers));
            
            // Remove related notifications
            notifications = notifications.filter(n => n.driverId !== id);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            renderDrivers();
            renderDashboard();
            updateNotificationBadge();
        }

        function renderDrivers() {
            const tbody = document.getElementById('drivers-tbody');
            
            if (drivers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">No drivers found</td></tr>';
                return;
            }
            
            tbody.innerHTML = drivers.map(driver => {
                const totalAdvances = advances
                    .filter(a => a.driverId === driver.id && a.status !== 'paid')
                    .reduce((sum, a) => sum + a.remaining, 0);
                
                let statusBadge = '';
                if (!driver.salaryActivated) {
                    statusBadge = '<span class="badge badge-training">üéì Training</span>';
                } else {
                    statusBadge = '<span class="badge badge-active">‚úÖ Active</span>';
                }
                
                const driverStopsCount = stops.filter(s => s.driverId === driver.id).length;
                const completedStopsCount = stops.filter(s => s.driverId === driver.id && s.status === 'completed').length;
                const progressPercent = driverStopsCount > 0 ? (completedStopsCount / driverStopsCount * 100).toFixed(0) : 0;
                
                return `
                    <tr>
                        <td class="font-semibold">${driver.name}</td>
                        <td>${driver.phone}</td>
                        <td>${driver.email}</td>
                        <td>${driver.joinDate}</td>
                        <td>${statusBadge}</td>
                        <td class="font-bold ${totalAdvances > 0 ? 'text-red-600' : 'text-green-600'}">
                            ¬£${totalAdvances.toFixed(2)}
                        </td>
                        <td>
                            <div class="text-xs">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-semibold">${completedStopsCount}/${driverStopsCount} stops</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openDriverModal('${driver.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-warning btn-sm" onclick="openAdvanceModalForDriver('${driver.id}')">üí∏</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDriver('${driver.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            populateDriverDropdowns();
        }

        function searchDrivers() {
            const searchTerm = document.getElementById('driver-search').value.toLowerCase();
            const filteredDrivers = drivers.filter(d => 
                d.name.toLowerCase().includes(searchTerm) ||
                d.phone.toLowerCase().includes(searchTerm) ||
                d.email.toLowerCase().includes(searchTerm)
            );
            
            const tbody = document.getElementById('drivers-tbody');
            tbody.innerHTML = filteredDrivers.map(driver => {
                const totalAdvances = advances
                    .filter(a => a.driverId === driver.id && a.status !== 'paid')
                    .reduce((sum, a) => sum + a.remaining, 0);
                
                let statusBadge = '';
                if (!driver.salaryActivated) {
                    statusBadge = '<span class="badge badge-training">üéì Training</span>';
                } else {
                    statusBadge = '<span class="badge badge-active">‚úÖ Active</span>';
                }
                
                const driverStopsCount = stops.filter(s => s.driverId === driver.id).length;
                const completedStopsCount = stops.filter(s => s.driverId === driver.id && s.status === 'completed').length;
                const progressPercent = driverStopsCount > 0 ? (completedStopsCount / driverStopsCount * 100).toFixed(0) : 0;
                
                return `
                    <tr>
                        <td class="font-semibold">${driver.name}</td>
                        <td>${driver.phone}</td>
                        <td>${driver.email}</td>
                        <td>${driver.joinDate}</td>
                        <td>${statusBadge}</td>
                        <td class="font-bold ${totalAdvances > 0 ? 'text-red-600' : 'text-green-600'}">
                            ¬£${totalAdvances.toFixed(2)}
                        </td>
                        <td>
                            <div class="text-xs">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-semibold">${completedStopsCount}/${driverStopsCount} stops</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openDriverModal('${driver.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-warning btn-sm" onclick="openAdvanceModalForDriver('${driver.id}')">üí∏</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDriver('${driver.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function populateDriverDropdowns() {
            const selects = document.querySelectorAll('#order-driver, #advance-driver');
            const html = '<option value="">-- Select Driver --</option>' + 
                drivers.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            
            selects.forEach(select => select.innerHTML = html);
        }

        // Company Management
        function openCompanyModal(id = null) {
            const modal = document.getElementById('company-modal');
            const title = document.getElementById('company-modal-title');
            const form = document.getElementById('company-form');
            
            form.reset();
            
            if (id) {
                const company = companies.find(c => c.id === id);
                title.textContent = '‚úèÔ∏è Edit Company';
                document.getElementById('company-id').value = company.id;
                document.getElementById('company-name').value = company.name;
                document.getElementById('company-contact').value = company.contact;
                document.getElementById('company-phone').value = company.phone;
                document.getElementById('company-email').value = company.email;
                document.getElementById('company-status').value = company.status;
                document.getElementById('company-notes').value = company.notes || '';
            } else {
                title.textContent = 'üè¢ Add New Company';
                document.getElementById('company-id').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeCompanyModal() {
            document.getElementById('company-modal').classList.remove('active');
        }

        function saveCompany(event) {
            event.preventDefault();
            
            const id = document.getElementById('company-id').value;
            const company = {
                id: id || Date.now().toString(),
                name: document.getElementById('company-name').value,
                contact: document.getElementById('company-contact').value,
                phone: document.getElementById('company-phone').value,
                email: document.getElementById('company-email').value,
                status: document.getElementById('company-status').value,
                notes: document.getElementById('company-notes').value,
                createdAt: id ? companies.find(c => c.id === id).createdAt : new Date().toISOString()
            };
            
            if (id) {
                const index = companies.findIndex(c => c.id === id);
                companies[index] = company;
            } else {
                companies.push(company);
            }
            
            localStorage.setItem('companies', JSON.stringify(companies));
            
            closeCompanyModal();
            renderCompanies();
            renderDashboard();
            
            alert('‚úÖ Company saved successfully!');
        }

        function deleteCompany(id) {
            if (!confirm('Are you sure you want to delete this company?')) return;
            
            companies = companies.filter(c => c.id !== id);
            localStorage.setItem('companies', JSON.stringify(companies));
            
            renderCompanies();
            renderDashboard();
        }

        function renderCompanies() {
            const tbody = document.getElementById('companies-tbody');
            
            if (companies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No companies found</td></tr>';
                return;
            }
            
            tbody.innerHTML = companies.map(company => `
                <tr>
                    <td class="font-semibold">${company.name}</td>
                    <td>${company.contact}</td>
                    <td>${company.phone}</td>
                    <td>${company.email}</td>
                    <td>
                        ${company.status === 'active' ? 
                            '<span class="badge badge-active">‚úÖ Active</span>' : 
                            '<span class="badge badge-inactive">‚è∏Ô∏è Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openCompanyModal('${company.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCompany('${company.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
            
            populateCompanyDropdowns();
        }

        function searchCompanies() {
            const searchTerm = document.getElementById('company-search').value.toLowerCase();
            const filteredCompanies = companies.filter(c => 
                c.name.toLowerCase().includes(searchTerm) ||
                c.contact.toLowerCase().includes(searchTerm) ||
                c.email.toLowerCase().includes(searchTerm)
            );
            
            const tbody = document.getElementById('companies-tbody');
            tbody.innerHTML = filteredCompanies.map(company => `
                <tr>
                    <td class="font-semibold">${company.name}</td>
                    <td>${company.contact}</td>
                    <td>${company.phone}</td>
                    <td>${company.email}</td>
                    <td>
                        ${company.status === 'active' ? 
                            '<span class="badge badge-active">‚úÖ Active</span>' : 
                            '<span class="badge badge-inactive">‚è∏Ô∏è Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openCompanyModal('${company.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCompany('${company.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function populateCompanyDropdowns() {
            const select = document.getElementById('order-company');
            select.innerHTML = '<option value="">-- Select Company --</option>' + 
                companies.filter(c => c.status === 'active').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // Order Management
        function openOrderModal(id = null) {
            const modal = document.getElementById('order-modal');
            const title = document.getElementById('order-modal-title');
            const form = document.getElementById('order-form');
            
            form.reset();
            populateCompanyDropdowns();
            populateDriverDropdowns();
            
            if (id) {
                const order = orders.find(o => o.id === id);
                title.textContent = '‚úèÔ∏è Edit Order';
                document.getElementById('order-id').value = order.id;
                document.getElementById('order-company').value = order.companyId;
                document.getElementById('order-driver').value = order.driverId;
                document.getElementById('order-date').value = order.date;
                document.getElementById('order-postcode').value = order.postcode || '';
                document.getElementById('order-customer').value = order.customer || '';
                document.getElementById('order-customer-phone').value = order.customerPhone || '';
                document.getElementById('order-revenue').value = order.revenue;
                document.getElementById('order-status').value = order.status;
                document.getElementById('order-notes').value = order.notes || '';
            } else {
                title.textContent = 'üì¶ Add New Order';
                document.getElementById('order-id').value = '';
                document.getElementById('order-date').value = new Date().toISOString().split('T')[0];
            }
            
            modal.classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
        }

        function saveOrder(event) {
            event.preventDefault();
            
            const id = document.getElementById('order-id').value;
            const order = {
                id: id || Date.now().toString(),
                companyId: document.getElementById('order-company').value,
                driverId: document.getElementById('order-driver').value,
                date: document.getElementById('order-date').value,
                postcode: document.getElementById('order-postcode').value,
                customer: document.getElementById('order-customer').value,
                customerPhone: document.getElementById('order-customer-phone').value,
                revenue: parseFloat(document.getElementById('order-revenue').value),
                status: document.getElementById('order-status').value,
                notes: document.getElementById('order-notes').value,
                createdAt: id ? orders.find(o => o.id === id).createdAt : new Date().toISOString()
            };
            
            if (id) {
                const index = orders.findIndex(o => o.id === id);
                orders[index] = order;
            } else {
                orders.push(order);
            }
            
            localStorage.setItem('orders', JSON.stringify(orders));
            
            closeOrderModal();
            renderOrders();
            renderDashboard();
            
            alert('‚úÖ Order saved successfully!');
        }

        function deleteOrder(id) {
            if (!confirm('Are you sure you want to delete this order?')) return;
            
            orders = orders.filter(o => o.id !== id);
            localStorage.setItem('orders', JSON.stringify(orders));
            
            renderOrders();
            renderDashboard();
        }

        function renderOrders() {
            const tbody = document.getElementById('orders-tbody');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const company = companies.find(c => c.id === order.companyId);
                const driver = drivers.find(d => d.id === order.driverId);
                
                let statusBadge = '';
                if (order.status === 'completed') {
                    statusBadge = '<span class="badge badge-completed">‚úÖ Completed</span>';
                } else if (order.status === 'in_progress') {
                    statusBadge = '<span class="badge badge-pending">üîÑ In Progress</span>';
                } else {
                    statusBadge = '<span class="badge badge-pending">‚è≥ Pending</span>';
                }
                
                return `
                    <tr>
                        <td class="font-mono">#${order.id.slice(-6)}</td>
                        <td>${order.date}</td>
                        <td>${company ? company.name : 'N/A'}</td>
                        <td>${driver ? driver.name : 'N/A'}</td>
                        <td class="font-bold text-green-600">¬£${order.revenue.toFixed(2)}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openOrderModal('${order.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function searchOrders() {
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            const filteredOrders = orders.filter(o => {
                const company = companies.find(c => c.id === o.companyId);
                const driver = drivers.find(d => d.id === o.driverId);
                return (
                    o.id.toLowerCase().includes(searchTerm) ||
                    (company && company.name.toLowerCase().includes(searchTerm)) ||
                    (driver && driver.name.toLowerCase().includes(searchTerm)) ||
                    o.postcode.toLowerCase().includes(searchTerm)
                );
            });
            
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = filteredOrders.map(order => {
                const company = companies.find(c => c.id === order.companyId);
                const driver = drivers.find(d => d.id === order.driverId);
                
                let statusBadge = '';
                if (order.status === 'completed') {
                    statusBadge = '<span class="badge badge-completed">‚úÖ Completed</span>';
                } else if (order.status === 'in_progress') {
                    statusBadge = '<span class="badge badge-pending">üîÑ In Progress</span>';
                } else {
                    statusBadge = '<span class="badge badge-pending">‚è≥ Pending</span>';
                }
                
                return `
                    <tr>
                        <td class="font-mono">#${order.id.slice(-6)}</td>
                        <td>${order.date}</td>
                        <td>${company ? company.name : 'N/A'}</td>
                        <td>${driver ? driver.name : 'N/A'}</td>
                        <td class="font-bold text-green-600">¬£${order.revenue.toFixed(2)}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openOrderModal('${order.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Advance Management
        function openAdvanceModal(id = null) {
            const modal = document.getElementById('advance-modal');
            const title = document.getElementById('advance-modal-title');
            const form = document.getElementById('advance-form');
            
            form.reset();
            populateDriverDropdowns();
            
            if (id) {
                const advance = advances.find(a => a.id === id);
                title.textContent = '‚úèÔ∏è Edit Advance';
                document.getElementById('advance-id').value = advance.id;
                document.getElementById('advance-driver').value = advance.driverId;
                document.getElementById('advance-date').value = advance.date;
                document.getElementById('advance-amount').value = advance.amount;
                document.getElementById('advance-deduction-type').value = advance.deductionType;
                document.getElementById('advance-partial-amount').value = advance.partialAmount || '';
                document.getElementById('advance-notes').value = advance.notes || '';
                
                if (advance.deductionType === 'partial') {
                    document.getElementById('partial-deduction-section').style.display = 'block';
                }
            } else {
                title.textContent = 'üí∏ Add Advance';
                document.getElementById('advance-id').value = '';
                document.getElementById('advance-date').value = new Date().toISOString().split('T')[0];
            }
            
            modal.classList.add('active');
        }

        function openAdvanceModalForDriver(driverId) {
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            if (!confirm(`üí∏ Add advance for ${driver.name}?`)) return;
            
            const modal = document.getElementById('advance-modal');
            const title = document.getElementById('advance-modal-title');
            const form = document.getElementById('advance-form');
            
            form.reset();
            populateDriverDropdowns();
            
            title.textContent = `üí∏ Add Advance for ${driver.name}`;
            document.getElementById('advance-id').value = '';
            document.getElementById('advance-driver').value = driverId;
            document.getElementById('advance-date').value = new Date().toISOString().split('T')[0];
            
            modal.classList.add('active');
        }

        function closeAdvanceModal() {
            document.getElementById('advance-modal').classList.remove('active');
        }

        function saveAdvance(event) {
            event.preventDefault();
            
            const id = document.getElementById('advance-id').value;
            const amount = parseFloat(document.getElementById('advance-amount').value);
            const deductionType = document.getElementById('advance-deduction-type').value;
            
            const advance = {
                id: id || Date.now().toString(),
                driverId: document.getElementById('advance-driver').value,
                date: document.getElementById('advance-date').value,
                amount: amount,
                remaining: id ? advances.find(a => a.id === id).remaining : amount,
                deductionType: deductionType,
                partialAmount: deductionType === 'partial' ? parseFloat(document.getElementById('advance-partial-amount').value) : null,
                notes: document.getElementById('advance-notes').value,
                status: 'active',
                createdAt: id ? advances.find(a => a.id === id).createdAt : new Date().toISOString()
            };
            
            if (id) {
                const index = advances.findIndex(a => a.id === id);
                advances[index] = { ...advances[index], ...advance };
            } else {
                advances.push(advance);
            }
            
            localStorage.setItem('advances', JSON.stringify(advances));
            
            closeAdvanceModal();
            renderAdvances();
            renderDrivers();
            
            alert('‚úÖ Advance saved successfully!');
        }

        function deleteAdvance(id) {
            if (!confirm('Are you sure you want to delete this advance?')) return;
            
            advances = advances.filter(a => a.id !== id);
            localStorage.setItem('advances', JSON.stringify(advances));
            
            renderAdvances();
            renderDrivers();
        }

        function renderAdvances() {
            const tbody = document.getElementById('advances-tbody');
            
            if (advances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No advances found</td></tr>';
                return;
            }
            
            tbody.innerHTML = advances.map(advance => {
                const driver = drivers.find(d => d.id === advance.driverId);
                
                let statusBadge = '';
                if (advance.status === 'paid') {
                    statusBadge = '<span class="badge badge-completed">‚úÖ Paid</span>';
                } else {
                    statusBadge = '<span class="badge badge-pending">‚è≥ Active</span>';
                }
                
                return `
                    <tr>
                        <td class="font-semibold">${driver ? driver.name : 'N/A'}</td>
                        <td>${advance.date}</td>
                        <td class="font-bold text-blue-600">¬£${advance.amount.toFixed(2)}</td>
                        <td class="font-bold ${advance.remaining > 0 ? 'text-red-600' : 'text-green-600'}">
                            ¬£${advance.remaining.toFixed(2)}
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openAdvanceModal('${advance.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAdvance('${advance.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Salary Calculations
        function calculateAllSalaries() {
            const startDate = document.getElementById('salary-start-date').value;
            const endDate = document.getElementById('salary-end-date').value;
            
            if (!startDate || !endDate) {
                alert('‚ö†Ô∏è Please select start and end dates');
                return;
            }
            
            renderSalaries(startDate, endDate);
            alert('‚úÖ Salaries calculated successfully!');
        }

        function filterSalaries() {
            const startDate = document.getElementById('salary-start-date').value;
            const endDate = document.getElementById('salary-end-date').value;
            
            if (!startDate || !endDate) {
                alert('‚ö†Ô∏è Please select start and end dates');
                return;
            }
            
            renderSalaries(startDate, endDate);
        }

        function renderSalaries(startDate = null, endDate = null) {
            const tbody = document.getElementById('salaries-tbody');
            
            if (!startDate || !endDate) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">Select dates and click Calculate</td></tr>';
                return;
            }
            
            const salaryData = drivers.map(driver => {
                // Filter orders for this driver within date range
                const driverOrders = orders.filter(o => 
                    o.driverId === driver.id &&
                    o.status === 'completed' &&
                    o.date >= startDate &&
                    o.date <= endDate
                );
                
                const orderCount = driverOrders.length;
                
                // Check if driver is still in training period
                const daysSinceJoin = Math.floor((new Date(endDate) - new Date(driver.joinDate)) / (1000 * 60 * 60 * 24));
                const inTraining = !driver.salaryActivated || daysSinceJoin < settings.trainingDays;
                
                // Calculate base salary
                let baseSalary = 0;
                let bonus = 0;
                
                if (!inTraining) {
                    if (orderCount >= settings.targetOrders) {
                        baseSalary = settings.baseSalary;
                        const extraOrders = orderCount - settings.targetOrders;
                        bonus = extraOrders * settings.bonusPerOrder;
                    }
                }
                
                // Calculate advance deductions
                let totalDeduction = 0;
                const driverAdvances = advances.filter(a => 
                    a.driverId === driver.id &&
                    a.status === 'active' &&
                    a.remaining > 0
                );
                
                driverAdvances.forEach(advance => {
                    if (advance.deductionType === 'full') {
                        const deduction = Math.min(advance.remaining, baseSalary + bonus);
                        totalDeduction += deduction;
                        advance.remaining -= deduction;
                        if (advance.remaining <= 0) {
                            advance.status = 'paid';
                            advance.remaining = 0;
                        }
                    } else if (advance.deductionType === 'partial' && advance.partialAmount) {
                        const deduction = Math.min(advance.partialAmount, advance.remaining, baseSalary + bonus);
                        totalDeduction += deduction;
                        advance.remaining -= deduction;
                        if (advance.remaining <= 0) {
                            advance.status = 'paid';
                            advance.remaining = 0;
                        }
                    }
                });
                
                // Save updated advances
                localStorage.setItem('advances', JSON.stringify(advances));
                
                const netSalary = baseSalary + bonus - totalDeduction;
                
                return {
                    driverId: driver.id,
                    driverName: driver.name,
                    orders: orderCount,
                    baseSalary,
                    bonus,
                    advances: totalDeduction,
                    netSalary,
                    inTraining,
                    period: `${startDate} to ${endDate}`
                };
            });
            
            tbody.innerHTML = salaryData.map(data => `
                <tr>
                    <td class="font-semibold">${data.driverName}</td>
                    <td class="text-sm">${data.period}</td>
                    <td class="font-bold">${data.orders}</td>
                    <td class="text-blue-600">¬£${data.baseSalary.toFixed(2)}</td>
                    <td class="text-green-600">¬£${data.bonus.toFixed(2)}</td>
                    <td class="text-red-600">-¬£${data.advances.toFixed(2)}</td>
                    <td class="font-bold text-purple-600">¬£${data.netSalary.toFixed(2)}</td>
                    <td>
                        ${data.inTraining ? 
                            '<span class="badge badge-training">üéì Training</span>' : 
                            '<span class="badge badge-active">‚úÖ Active</span>'}
                    </td>
                </tr>
            `).join('');
        }

        // Training Period Management
        function calculateTrainingEndDate(joinDate) {
            const date = new Date(joinDate);
            date.setDate(date.getDate() + settings.trainingDays);
            return date.toISOString().split('T')[0];
        }

        function checkTrainingPeriods() {
            const today = new Date().toISOString().split('T')[0];
            
            drivers.forEach(driver => {
                if (!driver.salaryActivated) {
                    const endDate = calculateTrainingEndDate(driver.joinDate);
                    
                    if (today >= endDate) {
                        // Check if notification already exists
                        const existingNotif = notifications.find(n => 
                            n.driverId === driver.id &&
                            n.type === 'training_complete' &&
                            !n.read
                        );
                        
                        if (!existingNotif) {
                            const notification = {
                                id: Date.now().toString() + Math.random(),
                                driverId: driver.id,
                                driverName: driver.name,
                                type: 'training_complete',
                                message: `${driver.name} has completed the training period! Please activate salary.`,
                                targetDate: endDate,
                                read: false,
                                actionRequired: true,
                                createdAt: new Date().toISOString()
                            };
                            notifications.push(notification);
                        }
                    }
                }
            });
            
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read && n.actionRequired).length;
            const badge = document.getElementById('notification-count');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function renderNotifications() {
            const container = document.getElementById('notifications-list');
            
            if (notifications.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No notifications</p>';
                return;
            }
            
            // Sort notifications by actionRequired and date
            const sortedNotifications = [...notifications].sort((a, b) => {
                if (a.actionRequired && !b.actionRequired) return -1;
                if (!a.actionRequired && b.actionRequired) return 1;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            container.innerHTML = sortedNotifications.map(notif => `
                <div class="notification-item ${notif.read ? '' : 'notification-unread'}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${notif.actionRequired ? 'üîî' : 'üìå'}</span>
                            <div>
                                <p class="font-bold text-gray-800">${notif.driverName}</p>
                                <p class="text-sm text-gray-600">${notif.message}</p>
                            </div>
                        </div>
                        ${notif.actionRequired ? 
                            `<button class="btn btn-success btn-sm" onclick="showTrainingNotification('${notif.driverId}', '${notif.id}')">
                                ‚úÖ Activate
                            </button>` : 
                            ''}
                    </div>
                    <p class="text-xs text-gray-500">Created: ${new Date(notif.createdAt).toLocaleString()}</p>
                </div>
            `).join('');
        }

        function showTrainingNotification(driverId, notificationId) {
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            currentNotificationDriverId = driverId;
            
            const modal = document.getElementById('training-notification-modal');
            const content = modal.querySelector('#notification-content p');
            
            content.textContent = `${driver.name} has completed the ${settings.trainingDays}-day training period. 
                Would you like to activate salary calculations for this driver?`;
            
            modal.classList.add('active');
        }

        function closeTrainingNotificationModal() {
            document.getElementById('training-notification-modal').classList.remove('active');
        }

        function confirmSalaryActivation() {
            if (!currentNotificationDriverId) return;
            
            const driver = drivers.find(d => d.id === currentNotificationDriverId);
            if (driver) {
                driver.salaryActivated = true;
                driver.status = 'active';
                localStorage.setItem('drivers', JSON.stringify(drivers));
                
                // Mark notification as read
                notifications = notifications.map(n => {
                    if (n.driverId === currentNotificationDriverId && n.actionRequired) {
                        return { ...n, read: true, actionRequired: false };
                    }
                    return n;
                });
                localStorage.setItem('notifications', JSON.stringify(notifications));
                
                renderDrivers();
                renderNotifications();
                updateNotificationBadge();
                
                alert(`‚úÖ Salary activated for ${driver.name}!`);
            }
            
            closeTrainingNotificationModal();
            currentNotificationDriverId = null;
        }

        // Reports & Analytics
        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            const reportDate = document.getElementById('report-date').value;
            
            if (!reportDate) {
                alert('‚ö†Ô∏è Please select a date');
                return;
            }
            
            let startDate, endDate;
            
            if (reportType === 'daily') {
                startDate = endDate = reportDate;
            } else if (reportType === 'weekly') {
                const date = new Date(reportDate);
                date.setDate(date.getDate() - date.getDay()); // Start of week
                startDate = date.toISOString().split('T')[0];
                date.setDate(date.getDate() + 6);
                endDate = date.toISOString().split('T')[0];
            } else if (reportType === 'monthly') {
                const date = new Date(reportDate);
                startDate = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
                endDate = new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString().split('T')[0];
            }
            
            const filteredOrders = orders.filter(o => 
                o.status === 'completed' &&
                o.date >= startDate &&
                o.date <= endDate
            );
            
            const totalOrders = filteredOrders.length;
            const totalRevenue = filteredOrders.reduce((sum, o) => sum + o.revenue, 0);
            const totalCosts = totalOrders * settings.driverCostPerOrder;
            const netProfit = totalRevenue - totalCosts;
            
            document.getElementById('report-orders').textContent = totalOrders;
            document.getElementById('report-revenue').textContent = `¬£${totalRevenue.toFixed(2)}`;
            document.getElementById('report-costs').textContent = `¬£${totalCosts.toFixed(2)}`;
            document.getElementById('report-profit').textContent = `¬£${netProfit.toFixed(2)}`;
            
            // Generate detailed breakdown by driver
            const driverBreakdown = {};
            
            filteredOrders.forEach(order => {
                const driver = drivers.find(d => d.id === order.driverId);
                const driverName = driver ? driver.name : 'Unknown';
                
                if (!driverBreakdown[order.driverId]) {
                    driverBreakdown[order.driverId] = {
                        name: driverName,
                        orders: 0,
                        revenue: 0,
                        costs: 0,
                        profit: 0
                    };
                }
                
                driverBreakdown[order.driverId].orders++;
                driverBreakdown[order.driverId].revenue += order.revenue;
                driverBreakdown[order.driverId].costs += settings.driverCostPerOrder;
                driverBreakdown[order.driverId].profit = driverBreakdown[order.driverId].revenue - driverBreakdown[order.driverId].costs;
            });
            
            const tbody = document.getElementById('report-tbody');
            const breakdown = Object.values(driverBreakdown);
            
            if (breakdown.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No data for selected period</td></tr>';
                return;
            }
            
            tbody.innerHTML = breakdown.map(data => `
                <tr>
                    <td>${startDate}${startDate !== endDate ? ' - ' + endDate : ''}</td>
                    <td class="font-semibold">${data.name}</td>
                    <td class="font-bold">${data.orders}</td>
                    <td class="text-green-600">¬£${data.revenue.toFixed(2)}</td>
                    <td class="text-red-600">¬£${data.costs.toFixed(2)}</td>
                    <td class="font-bold text-purple-600">¬£${data.profit.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        function exportReport() {
            const reportDate = document.getElementById('report-date').value;
            
            if (!reportDate) {
                alert('‚ö†Ô∏è Please generate a report first');
                return;
            }
            
            const orders = document.getElementById('report-orders').textContent;
            const revenue = document.getElementById('report-revenue').textContent;
            const costs = document.getElementById('report-costs').textContent;
            const profit = document.getElementById('report-profit').textContent;
            
            const reportContent = `
DRIVER MANAGEMENT SYSTEM - DAILY PROFIT REPORT
================================================

Report Date: ${reportDate}
Generated: ${new Date().toLocaleString()}

SUMMARY
-------
Completed Orders: ${orders}
Total Revenue: ${revenue}
Driver Costs: ${costs}
Net Profit: ${profit}

DETAILED BREAKDOWN
------------------
${document.getElementById('report-tbody').innerText}

================================================
            `;
            
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `profit-report-${reportDate}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Report exported successfully!');
        }

        // Request Management
        function openRequestModal() {
            document.getElementById('request-modal').classList.add('active');
        }

        function closeRequestModal() {
            document.getElementById('request-modal').classList.remove('active');
        }

        function saveRequest(event) {
            event.preventDefault();
            
            const type = document.getElementById('request-type').value;
            const description = document.getElementById('request-description').value;
            
            if (!type || !description) {
                alert('‚ö†Ô∏è Please fill all fields');
                return;
            }
            
            const notification = {
                id: Date.now().toString(),
                type: 'request',
                requestType: type,
                message: `New ${type} request: ${description}`,
                description: description,
                read: false,
                actionRequired: false,
                createdAt: new Date().toISOString()
            };
            
            notifications.push(notification);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            closeRequestModal();
            updateNotificationBadge();
            
            alert('‚úÖ Request submitted successfully!');
        }

        // Data Management
        function exportAllData() {
            const data = {
                drivers,
                companies,
                orders,
                advances,
                notifications,
                settings,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dms-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            localStorage.setItem('lastBackup', new Date().toISOString());
            document.getElementById('last-backup').textContent = new Date().toLocaleString();
            
            alert('‚úÖ Data exported successfully!');
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‚ö†Ô∏è Please select a file to import');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è This will replace all current data. Continue?')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.drivers || !data.companies || !data.orders) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Import data
                    drivers = data.drivers || [];
                    companies = data.companies || [];
                    orders = data.orders || [];
                    advances = data.advances || [];
                    notifications = data.notifications || [];
                    settings = data.settings || settings;
                    
                    // Save to localStorage
                    localStorage.setItem('drivers', JSON.stringify(drivers));
                    localStorage.setItem('companies', JSON.stringify(companies));
                    localStorage.setItem('orders', JSON.stringify(orders));
                    localStorage.setItem('advances', JSON.stringify(advances));
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    localStorage.setItem('settings', JSON.stringify(settings));
                    
                    // Refresh all views
                    initializeApp();
                    
                    alert('‚úÖ Data imported successfully!');
                } catch (error) {
                    alert('‚ùå Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL data permanently. Are you absolutely sure?')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è FINAL WARNING: This action cannot be undone!')) {
                return;
            }
            
            localStorage.clear();
            location.reload();
        }

        // Dashboard Rendering
        function renderDashboard() {
            // Update statistics
            document.getElementById('stat-drivers').textContent = drivers.length;
            document.getElementById('stat-companies').textContent = companies.filter(c => c.status === 'active').length;
            document.getElementById('stat-orders').textContent = orders.length;
            
            const totalRevenue = orders.reduce((sum, o) => sum + o.revenue, 0);
            document.getElementById('stat-revenue').textContent = `¬£${totalRevenue.toFixed(2)}`;
            
            // Recent Orders
            const recentOrders = orders
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);
            
            const recentOrdersHtml = recentOrders.length > 0 ?
                recentOrders.map(order => {
                    const company = companies.find(c => c.id === order.companyId);
                    const driver = drivers.find(d => d.id === order.driverId);
                    return `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <div>
                                <p class="font-semibold text-sm">${company ? company.name : 'N/A'}</p>
                                <p class="text-xs text-gray-600">${driver ? driver.name : 'N/A'} ‚Ä¢ ${order.date}</p>
                            </div>
                            <span class="font-bold text-green-600">¬£${order.revenue.toFixed(2)}</span>
                        </div>
                    `;
                }).join('') :
                '<p class="text-gray-500 text-sm">No recent orders</p>';
            
            document.getElementById('recent-orders').innerHTML = recentOrdersHtml;
            
            // Active Drivers
            const activeDrivers = drivers.filter(d => d.salaryActivated).slice(0, 5);
            
            const activeDriversHtml = activeDrivers.length > 0 ?
                activeDrivers.map(driver => {
                    const driverOrders = orders.filter(o => o.driverId === driver.id && o.status === 'completed').length;
                    return `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <div>
                                <p class="font-semibold text-sm">${driver.name}</p>
                                <p class="text-xs text-gray-600">${driver.phone}</p>
                            </div>
                            <span class="badge badge-active">${driverOrders} orders</span>
                        </div>
                    `;
                }).join('') :
                '<p class="text-gray-500 text-sm">No active drivers</p>';
            
            document.getElementById('active-drivers').innerHTML = activeDriversHtml;
            
            updateSystemInfo();
        }
    </script>
</body>
</html>
